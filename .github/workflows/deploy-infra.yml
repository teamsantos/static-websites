name: Deploy Infrastructure
on:
  push:
    branches: [master]
    paths:
        - 'infra/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'master' && 'production' || 'staging' }}
    container:
      image: ghcr.io/${{ github.repository_owner }}/static-websites:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # Set to us-east-1 for CloudFront certificates

      - name: Install infra dependencies
        working-directory: infra
        run: |
          echo "Installing infra dependencies..."
          # Handle lock file sync issues
          if ! npm ci 2>/dev/null; then
            echo "npm ci failed, falling back to npm install..."
            rm -rf node_modules package-lock.json
            npm install
          fi
          echo "‚úÖ Infra dependencies installed"

      - name: Install CDK CLI globally
        run: |
          echo "Installing CDK CLI globally..."
          npm install -g aws-cdk typescript ts-node
          echo "‚úÖ CDK CLI installed"

      - name: Check if CDK bootstrap is needed
        id: check-bootstrap
        working-directory: infra
        shell: bash
        run: |
          echo "Checking CDK bootstrap status..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # Minimum required bootstrap version
          MIN_BOOTSTRAP_VERSION=30
          
          # Function to check if region is bootstrapped with correct version
          check_bootstrap() {
            local region=$1
            echo "Checking bootstrap for region: $region"
            
            # Check if stack exists
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$STACK_STATUS" = "NOT_FOUND" ]; then
              echo "Stack CDKToolkit not found in $region - needs bootstrapping"
              return 1
            fi
            
            if ! echo "$STACK_STATUS" | grep -q "COMPLETE"; then
              echo "Stack CDKToolkit in $region is in status: $STACK_STATUS - needs bootstrapping"
              return 1
            fi
            
            # Check bootstrap version from stack outputs
            BOOTSTRAP_VERSION=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].Outputs[?OutputKey==`BootstrapVersion`].OutputValue' \
              --output text 2>/dev/null || echo "0")
            
            if [ -z "$BOOTSTRAP_VERSION" ] || [ "$BOOTSTRAP_VERSION" = "None" ]; then
              BOOTSTRAP_VERSION=0
            fi
            
            echo "Bootstrap version in $region: $BOOTSTRAP_VERSION (minimum required: $MIN_BOOTSTRAP_VERSION)"
            
            if [ "$BOOTSTRAP_VERSION" -lt "$MIN_BOOTSTRAP_VERSION" ]; then
              echo "Bootstrap version $BOOTSTRAP_VERSION is outdated (need >= $MIN_BOOTSTRAP_VERSION) - needs re-bootstrapping"
              return 1
            fi
            
            echo "Region $region is properly bootstrapped (version $BOOTSTRAP_VERSION)"
            return 0
          }
          
          # Check required regions
          BOOTSTRAP_NEEDED=""
          
          # Check us-east-1 (required for CloudFront certificates)
          if ! check_bootstrap "us-east-1"; then
            BOOTSTRAP_NEEDED="$BOOTSTRAP_NEEDED us-east-1"
          fi
          
          # Check eu-south-2 (your S3 bucket region - optional but recommended)
          if ! check_bootstrap "eu-south-2"; then
            BOOTSTRAP_NEEDED="$BOOTSTRAP_NEEDED eu-south-2"
          fi
          
          # Clean up and set output
          BOOTSTRAP_NEEDED=$(echo "$BOOTSTRAP_NEEDED" | xargs)
          echo "bootstrap-needed=$BOOTSTRAP_NEEDED" >> $GITHUB_OUTPUT
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          if [ -n "$BOOTSTRAP_NEEDED" ]; then
            echo "Bootstrap needed for regions: $BOOTSTRAP_NEEDED"
          else
            echo "All regions are properly bootstrapped with version >= $MIN_BOOTSTRAP_VERSION"
          fi

      - name: Bootstrap CDK regions
        if: steps.check-bootstrap.outputs.bootstrap-needed != ''
        working-directory: infra
        shell: bash
        run: |
          echo "Bootstrapping CDK for regions: ${{ steps.check-bootstrap.outputs.bootstrap-needed }}"
          ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
          
          for region in ${{ steps.check-bootstrap.outputs.bootstrap-needed }}; do
            echo "Bootstrapping region: $region"
            CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=$region \
            npx cdk bootstrap "aws://$ACCOUNT_ID/$region" \
              --require-approval never \
              --force \
              --verbose
            
            # Verify bootstrap was successful and show version
            BOOTSTRAP_VERSION=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].Outputs[?OutputKey==`BootstrapVersion`].OutputValue' \
              --output text 2>/dev/null || echo "unknown")
            
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "FAILED")
            
            if echo "$STACK_STATUS" | grep -q "COMPLETE"; then
              echo "Successfully bootstrapped $region (version: $BOOTSTRAP_VERSION)"
            else
              echo "Failed to bootstrap $region (status: $STACK_STATUS)"
              exit 1
            fi
          done

      - name: Install Lambda dependencies (create-project)
        working-directory: infra/lambda/create-project
        run: |
          echo "üì¶ Installing Lambda dependencies..."
          npm ci
          echo "‚úÖ Lambda dependencies installed"

      - name: Install Lambda dependencies (payment-session)
        working-directory: infra/lambda/payment-session
        run: |
          echo "üì¶ Installing Lambda dependencies..."
          npm ci
          echo "‚úÖ Lambda dependencies installed"

      - name: Install Lambda dependencies (generate-website)
        working-directory: infra/lambda/generate-website
        run: |
          echo "üì¶ Installing Lambda dependencies..."
          npm ci
          echo "‚úÖ Lambda dependencies installed"

      - name: Install Lambda dependencies (contact-form)
        working-directory: infra/lambda/contact-form
        run: |
          echo "üì¶ Installing Lambda dependencies..."
          npm ci
          echo "‚úÖ Lambda dependencies installed"

      - name: Build CDK project
        working-directory: infra
        run: |
          echo "üî® Building CDK project..."
          # Use npx to ensure we use the local typescript
          npx tsc
          echo "‚úÖ CDK project built successfully"

      - name: Handle orphaned SSM parameters
        working-directory: infra
        shell: bash
        run: |
          echo "üîç Checking for orphaned SSM certificate parameters..."
          
          # List of SSM parameter paths that CertificateManager might create
          PARAM_PATHS=(
            "/acm/certificates/e-info.click"
            "/acm/certificates/template.e-info.click"
          )
          
          for PARAM_PATH in "${PARAM_PATHS[@]}"; do
            echo "Checking parameter: $PARAM_PATH"
            
            # Check if SSM parameter exists
            PARAM_VALUE=$(aws ssm get-parameter --name "$PARAM_PATH" --region us-east-1 --query "Parameter.Value" --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$PARAM_VALUE" != "NOT_FOUND" ]; then
              echo "Found existing SSM parameter: $PARAM_PATH"
              echo "Value: $PARAM_VALUE"
              
              # Check if the certificate ARN is valid
              if [[ "$PARAM_VALUE" == arn:aws:acm:* ]]; then
                # Verify certificate exists
                CERT_STATUS=$(aws acm describe-certificate --certificate-arn "$PARAM_VALUE" --region us-east-1 --query "Certificate.Status" --output text 2>/dev/null || echo "NOT_FOUND")
                
                if [ "$CERT_STATUS" = "NOT_FOUND" ] || [ "$CERT_STATUS" = "EXPIRED" ] || [ "$CERT_STATUS" = "REVOKED" ]; then
                  echo "Certificate is invalid or not found (status: $CERT_STATUS). Deleting orphaned SSM parameter..."
                  aws ssm delete-parameter --name "$PARAM_PATH" --region us-east-1 || true
                  echo "‚úÖ Deleted orphaned SSM parameter: $PARAM_PATH"
                else
                  echo "Certificate is valid (status: $CERT_STATUS)"
                  
                  # Extract domain from parameter path for context key
                  DOMAIN=$(echo "$PARAM_PATH" | sed 's|/acm/certificates/||')
                  ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
                  
                  # Update cdk.context.json with the existing certificate ARN
                  echo "Updating cdk.context.json with existing certificate..."
                  CONTEXT_KEY="ssm:account=${ACCOUNT_ID}:parameterName=${PARAM_PATH}:region=us-east-1"
                  
                  # Read existing context or create new one
                  if [ -f cdk.context.json ]; then
                    # Add/update the SSM parameter value in context
                    jq --arg key "$CONTEXT_KEY" --arg value "$PARAM_VALUE" '. + {($key): $value}' cdk.context.json > cdk.context.json.tmp
                    mv cdk.context.json.tmp cdk.context.json
                  else
                    echo "{\"$CONTEXT_KEY\": \"$PARAM_VALUE\"}" > cdk.context.json
                  fi
                  
                  echo "‚úÖ Updated cdk.context.json with certificate ARN"
                  cat cdk.context.json
                fi
              else
                echo "SSM parameter value is not a valid ACM ARN. Deleting..."
                aws ssm delete-parameter --name "$PARAM_PATH" --region us-east-1 || true
                echo "‚úÖ Deleted invalid SSM parameter: $PARAM_PATH"
              fi
            else
              echo "SSM parameter not found: $PARAM_PATH (this is OK for fresh deployments)"
            fi
          done
          
          echo "‚úÖ SSM parameter check completed"

      # - name: Preview infrastructure changes
      #   working-directory: infra
      #   shell: bash
      #   run: |
      #     echo "üîç Previewing infrastructure changes..."
      #     ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
      #     CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=us-east-1 \
      #     npx cdk diff --all || true

      - name: Deploy infrastructure
        working-directory: infra
        shell: bash
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          echo "üöÄ Deploying infrastructure..."
          ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
          
          # Deploy all stacks (BucketStack and CreateProjectStack only, since no projects/templates context)
          CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=us-east-1 \
          npx cdk deploy --all \
            --require-approval never \
            --verbose
          
          echo "‚úÖ Successfully deployed infrastructure"

      - name: Clean up Lambda node_modules
        shell: bash
        run: |
          echo "üßπ Cleaning up Lambda node_modules directories..."
          for lambda_dir in infra/lambda/*/; do
            if [ -d "$lambda_dir/node_modules" ]; then
              echo "Removing node_modules from $(basename "$lambda_dir")"
              rm -rf "$lambda_dir/node_modules"
              rm -f "$lambda_dir/package-lock.json"
            fi
          done
          echo "‚úÖ Lambda cleanup completed"

      - name: Deployment Summary
        shell: bash
        run: |
          echo "üéâ Infrastructure Deployment Summary"
          echo "===================================="
          echo "Deployed stacks:"
          echo "  ‚Ä¢ StaticWebsitesBucket (S3 bucket for static websites)"
          echo "  ‚Ä¢ CreateProjectStack (Lambda function for project creation)"
          echo ""
          echo "üìä S3 bucket: teamsantos-static-websites"
          echo "üåç Certificate region: us-east-1"
          echo "üóÇÔ∏è S3 region: eu-south-2"
