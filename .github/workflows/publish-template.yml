name: Deploy Templates
on:
  push:
    branches: [master]
    paths:
        - 'templates/**'
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'Force deploy all templates'
        required: false
        default: 'false'

env:
  S3_BUCKET: teamsantos-static-websites

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.changed.outputs.templates }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history

      - id: changed
        run: |
          echo "Checking for changed templates..."
          echo "Before commit: ${{ github.event.before }}"
          echo "Current commit: ${{ github.sha }}"
          
           # Check if this is a manual dispatch with force deploy
           if [ "${{ github.event.inputs.force_deploy_all }}" == "true" ]; then
             echo "Force deploy all templates requested"
             CHANGED=$(find templates -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
           elif [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
             # First push or new branch - check all templates folders
             echo "First push detected, checking all templates"
             CHANGED=$(find templates -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
           else
             # Check if both commits exist
             if git cat-file -e "${{ github.event.before }}" 2>/dev/null && git cat-file -e "${{ github.sha }}" 2>/dev/null; then
               echo "Both commits found, doing normal diff"
               # Get changed files, then filter to only directories
               CHANGED_FILES=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" 2>/dev/null \
                 | grep '^templates/' | cut -d/ -f2 | sort -u || echo "")

               # Filter to only directories (exclude files like buildTemplates.sh)
               CHANGED=""
               for item in $CHANGED_FILES; do
                 if [ -d "templates/$item" ]; then
                   CHANGED="$CHANGED $item"
                 fi
               done
               CHANGED=$(echo "$CHANGED" | xargs | sort -u || echo "")
             else
               echo "One or both commits not found, trying fallback methods..."
               # Try HEAD~1 comparison
               if git cat-file -e "HEAD~1" 2>/dev/null; then
                 echo "Using HEAD~1 comparison"
                 CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null \
                   | grep '^templates/' | cut -d/ -f2 | sort -u || echo "")

                 # Filter to only directories
                 CHANGED=""
                 for item in $CHANGED_FILES; do
                   if [ -d "templates/$item" ]; then
                     CHANGED="$CHANGED $item"
                   fi
                 done
                 CHANGED=$(echo "$CHANGED" | xargs | sort -u || echo "")
               else
                 # Last resort - deploy all templates
                 echo "Cannot determine changes, deploying all templates"
                 CHANGED=$(find templates -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
               fi
             fi
           fi
          
           # If still no changes detected, force deploy all as fallback
           if [ -z "$CHANGED" ]; then
             echo "No changes detected, falling back to deploy all templates"
             CHANGED=$(find templates -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
           fi

           # Final filter to ensure only directories are included
           FINAL_CHANGED=""
           for item in $CHANGED; do
             if [ -d "templates/$item" ]; then
               FINAL_CHANGED="$FINAL_CHANGED $item"
             fi
           done
           CHANGED=$(echo "$FINAL_CHANGED" | xargs | sort -u || echo "")
          
          # Convert to space-separated string for output
          CHANGED_STR=$(echo "$CHANGED" | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          echo "Changed templates: $CHANGED_STR"
          echo "templates=$CHANGED_STR" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.templates != ''
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'master' && 'production' || 'staging' }}
    container:
      image: ghcr.io/${{ github.repository_owner }}/static-websites:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # Set to us-east-1 for CloudFront certificates

      - name: Install infra dependencies
        working-directory: infra
        run: |
          echo "Installing infra dependencies..."
          # Handle lock file sync issues
          if ! npm ci 2>/dev/null; then
            echo "npm ci failed, falling back to npm install..."
            rm -rf node_modules package-lock.json
            npm install
          fi
          echo "‚úÖ Infra dependencies installed"

      - name: Install CDK CLI globally
        run: |
          echo "Installing CDK CLI globally..."
          npm install -g aws-cdk typescript ts-node
          echo "‚úÖ CDK CLI installed"

      - name: Check if CDK bootstrap is needed
        id: check-bootstrap
        working-directory: infra
        shell: bash
        run: |
          echo "Checking CDK bootstrap status..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # Minimum required bootstrap version
          MIN_BOOTSTRAP_VERSION=30
          
          # Function to check if region is bootstrapped with correct version
          check_bootstrap() {
            local region=$1
            echo "Checking bootstrap for region: $region"
            
            # Check if stack exists
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$STACK_STATUS" = "NOT_FOUND" ]; then
              echo "Stack CDKToolkit not found in $region - needs bootstrapping"
              return 1
            fi
            
            if ! echo "$STACK_STATUS" | grep -q "COMPLETE"; then
              echo "Stack CDKToolkit in $region is in status: $STACK_STATUS - needs bootstrapping"
              return 1
            fi
            
            # Check bootstrap version from stack outputs
            BOOTSTRAP_VERSION=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].Outputs[?OutputKey==`BootstrapVersion`].OutputValue' \
              --output text 2>/dev/null || echo "0")
            
            if [ -z "$BOOTSTRAP_VERSION" ] || [ "$BOOTSTRAP_VERSION" = "None" ]; then
              BOOTSTRAP_VERSION=0
            fi
            
            echo "Bootstrap version in $region: $BOOTSTRAP_VERSION (minimum required: $MIN_BOOTSTRAP_VERSION)"
            
            if [ "$BOOTSTRAP_VERSION" -lt "$MIN_BOOTSTRAP_VERSION" ]; then
              echo "Bootstrap version $BOOTSTRAP_VERSION is outdated (need >= $MIN_BOOTSTRAP_VERSION) - needs re-bootstrapping"
              return 1
            fi
            
            echo "Region $region is properly bootstrapped (version $BOOTSTRAP_VERSION)"
            return 0
          }
          
          # Check required regions
          BOOTSTRAP_NEEDED=""
          
          # Check us-east-1 (required for CloudFront certificates)
          if ! check_bootstrap "us-east-1"; then
            BOOTSTRAP_NEEDED="$BOOTSTRAP_NEEDED us-east-1"
          fi
          
          # Check eu-south-2 (your S3 bucket region - optional but recommended)
          if ! check_bootstrap "eu-south-2"; then
            BOOTSTRAP_NEEDED="$BOOTSTRAP_NEEDED eu-south-2"
          fi
          
          # Clean up and set output
          BOOTSTRAP_NEEDED=$(echo "$BOOTSTRAP_NEEDED" | xargs)
          echo "bootstrap-needed=$BOOTSTRAP_NEEDED" >> $GITHUB_OUTPUT
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          if [ -n "$BOOTSTRAP_NEEDED" ]; then
            echo "Bootstrap needed for regions: $BOOTSTRAP_NEEDED"
          else
            echo "All regions are properly bootstrapped with version >= $MIN_BOOTSTRAP_VERSION"
          fi

      - name: Bootstrap CDK regions
        if: steps.check-bootstrap.outputs.bootstrap-needed != ''
        working-directory: infra
        shell: bash
        run: |
          echo "Bootstrapping CDK for regions: ${{ steps.check-bootstrap.outputs.bootstrap-needed }}"
          ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
          
          for region in ${{ steps.check-bootstrap.outputs.bootstrap-needed }}; do
            echo "Bootstrapping region: $region"
            CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=$region \
            npx cdk bootstrap "aws://$ACCOUNT_ID/$region" \
              --require-approval never \
              --verbose \
              -c "templates=dummy"
            
            # Verify bootstrap was successful and show version
            BOOTSTRAP_VERSION=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].Outputs[?OutputKey==`BootstrapVersion`].OutputValue' \
              --output text 2>/dev/null || echo "unknown")
            
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --region "$region" \
              --stack-name CDKToolkit \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "FAILED")
            
            if echo "$STACK_STATUS" | grep -q "COMPLETE"; then
              echo "Successfully bootstrapped $region (version: $BOOTSTRAP_VERSION)"
            else
              echo "Failed to bootstrap $region (status: $STACK_STATUS)"
              exit 1
            fi
          done

      - name: Build CDK template
        working-directory: infra
        run: |
          echo "üî® Building CDK template..."
          # Use npx to ensure we use the local typescript
          npx tsc
          echo "‚úÖ CDK template built successfully"

      - name: Convert template to comma-separated format
        id: format-templates
        shell: bash
        run: |
          # Convert space-separated templates to comma-separated
          TEMPLATES_SPACE="${{ needs.detect-changes.outputs.templates }}"
          TEMPLATES_COMMA=$(echo "$TEMPLATES_SPACE" | tr ' ' ',' | sed 's/,*$//' | sed 's/^,*//')
          echo "templates-comma=$TEMPLATES_COMMA" >> $GITHUB_OUTPUT
          echo "üì¶ Templates to deploy (comma-separated): $TEMPLATES_COMMA"

      # - name: Preview infrastructure changes
      #   working-directory: infra
      #   shell: bash
      #   run: |
      #     echo "üîç Previewing changes for templates: ${{ steps.format-templates.outputs.templates-comma }}"
      #     ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
      #     CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=us-east-1 \
      #     npx cdk diff --all \
      #       --context "templates=${{ steps.format-templates.outputs.templates-comma }}" || true

      # - name: Deploy infrastructure
      #   working-directory: infra
      #   shell: bash
      #   run: |
      #     echo "üöÄ Deploying infrastructure for templates: ${{ steps.format-templates.outputs.templates-comma }}"
      #     ACCOUNT_ID="${{ steps.check-bootstrap.outputs.account-id }}"
      #
      #     # Deploy all stacks at once with comma-separated templates
      #     CDK_DEFAULT_ACCOUNT=$ACCOUNT_ID CDK_DEFAULT_REGION=us-east-1 \
      #     npx cdk deploy --all \
      #       --context "templates=${{ steps.format-templates.outputs.templates-comma }}" \
      #       --require-approval never \
      #       --verbose
      #
      #     echo "‚úÖ Successfully deployed infrastructure for all templates"

      - name: Build templates
        shell: bash
        run: |
           echo "üî® Building templates..."
           if [ -z "${{ needs.detect-changes.outputs.templates }}" ]; then
             echo "‚ö†Ô∏è No templates to build"
           else
             # Build only the changed templates
             npm run build:template ${{ needs.detect-changes.outputs.templates }}
           fi

      - name: Sync built sites to S3
        shell: bash
        run: |
          echo "üì§ Syncing built sites to S3..."
          IFS=' ' read -ra TEMP_ARR <<< "${{ needs.detect-changes.outputs.templates }}"
          for template in "${TEMP_ARR[@]}"; do
            if [ -n "$template" ]; then
              echo "Syncing $template to S3..."
              
               if [ -d "templates/$template/dist" ]; then
                 # Sync to the fixed bucket with template path
                 _template=$(echo "$template" | tr '[:upper:]' '[:lower:]')

                 aws s3 sync "templates/$template/dist" "s3://$S3_BUCKET/templates/$_template" \
                   --delete \
                   --region eu-south-2 \
                   --exclude ".*"

                 echo "‚úÖ Synced $template to s3://$S3_BUCKET/$_template"
               else
                 echo "‚ö†Ô∏è Build directory templates/$template/dist not found for $template"
               fi
            fi
          done

      - name: Invalidate CloudFront cache
        shell: bash
        run: |
          echo "Invalidating CloudFront cache for TemplateDistribution..."
          
          # Get the TemplateDistribution distribution ID from stack outputs
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --region us-east-1 \
            --stack-name "TemplateDistribution" \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' \
            --output text 2>/dev/null)
          
          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "Creating invalidation for distribution: $DISTRIBUTION_ID"
            aws cloudfront create-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --paths "/*" \
              --output table
            echo "Cache invalidated for all templates"
          else
            echo "No distribution ID found for TemplateDistribution stack"
            exit 1
          fi

      - name: Deployment Summary
        shell: bash
        run: |
          echo "Deployment Summary"
          echo "===================="
          echo "Deployed templates: ${{ needs.detect-changes.outputs.templates }}"
          echo "Total templates: $(echo '${{ needs.detect-changes.outputs.templates }}' | wc -w)"
          echo ""
          echo "Access your templates at:"
          IFS=' ' read -ra TEMP_ARR <<< "${{ needs.detect-changes.outputs.templates }}"
          for template in "${TEMP_ARR[@]}"; do
            if [ -n "$template" ]; then
              _template=$(echo "$template" | tr '[:upper:]' '[:lower:]')
              echo "  - https://$_template.template.e-info.click"
            fi
          done
          echo ""
          echo "S3 bucket: $S3_BUCKET"
          echo "Certificate region: us-east-1"
          echo "S3 region: eu-south-2"
          echo "Distribution: TemplateDistribution (shared multi-tenant)"
